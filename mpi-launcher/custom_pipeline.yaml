apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: launch-kubeflow-mpi-job-
  annotations: {pipelines.kubeflow.org/kfp_sdk_version: 1.8.22, pipelines.kubeflow.org/pipeline_compilation_time: '2024-02-27T08:14:16.897396',
    pipelines.kubeflow.org/pipeline_spec: '{"description": "An example to launch deepspeed.",
      "inputs": [{"default": "", "description": "Name for MPI-Job (string)", "name":
      "name", "optional": true, "type": "String"}, {"default": "", "description":
      "Namespace for MPI-Job (string)", "name": "namespace", "optional": true, "type":
      "String"}, {"default": "", "description": "Image registry for workers (string)",
      "name": "image", "optional": true, "type": "String"}, {"default": "", "description":
      "Command for workers (string)", "name": "command", "optional": true, "type":
      "String"}, {"default": "3", "description": "Number of workers (integer)", "name":
      "num_worker", "optional": true, "type": "Integer"}, {"default": "16", "description":
      "CPU allocation per worker (integer: Cores)", "name": "cpu_per_worker", "optional":
      true, "type": "Integer"}, {"default": "32", "description": "Memory allocation
      per worker (integer: GiB)", "name": "memory_per_worker", "optional": true, "type":
      "Integer"}, {"default": "1", "description": "GPU allocation per worker (integer)",
      "name": "gpu_per_worker", "optional": true, "type": "Integer"}], "name": "launch-kubeflow-mpi-job"}'}
  labels: {pipelines.kubeflow.org/kfp_sdk_version: 1.8.22}
spec:
  entrypoint: launch-kubeflow-mpi-job
  templates:
  - name: clear-mpi-job
    container:
      args: [--name, '{{inputs.parameters.name}}', --namespace, '{{inputs.parameters.namespace}}',
        --num-worker, '{{inputs.parameters.num_worker}}', --version, v1]
      command:
      - sh
      - -c
      - (PIP_DISABLE_PIP_VERSION_CHECK=1 python3 -m pip install --quiet --no-warn-script-location
        'kubernetes' || PIP_DISABLE_PIP_VERSION_CHECK=1 python3 -m pip install --quiet
        --no-warn-script-location 'kubernetes' --user) && "$0" "$@"
      - sh
      - -ec
      - |
        program_path=$(mktemp)
        printf "%s" "$0" > "$program_path"
        python3 -u "$program_path" "$@"
      - |
        def Clear_MPI_Job(name, namespace, num_worker, version="v1"):
            import kubernetes
            kubernetes.config.load_incluster_config()
            api_instance_custom = kubernetes.client.CustomObjectsApi()
            api_instance_core = kubernetes.client.CoreV1Api()
            group = "kubeflow.org"
            plural = "mpijobs"
            try:
                api_response = api_instance_custom.delete_namespaced_custom_object(
                    name=name,
                    namespace=namespace,
                    group=group,
                    version=version,
                    plural=plural,
                    body=kubernetes.client.models.V1DeleteOptions(
                        propagation_policy='Foreground',
                        grace_period_seconds=15
                    )
                )
                print("MPI-Job %s/%s deleted. Status='%s'" % (name, namespace, str(api_response.get("status", None))))
            except kubernetes.client.rest.ApiException as e:
                print("Exception when calling CustomObjectsApi->delete_namespaced_custom_object: %s\n" % e)

            try:
                api_response = api_instance_core.delete_namespaced_service(name=f"{name}-launcher", namespace=namespace, body={"propagationPolicy": "Foreground"})
                print("Service %s/%s deleted. Status='%s'" % (f"{name}-launcher", namespace, str(api_response.status)))
                for index in range(int(num_worker)):
                    api_response = api_instance_core.delete_namespaced_service(name=f"{name}-worker-{index}", namespace=namespace, body={"propagationPolicy": "Foreground"})
                    print("Service %s/%s deleted. Status='%s'" % (f"{name}-worker-{index}", namespace, str(api_response.status)))
            except kubernetes.client.rest.ApiException as e:
                print("Exception when calling CoreV1Api->delete_namespaced_service: %s\n" % e)

            try:
                api_response = api_instance_core.delete_namespaced_service_account(name=f"{name}-launcher", namespace=namespace, body={"propagationPolicy": "Foreground"})
                print("ServiceAccount %s/%s deleted. Status='%s'" % (f"{name}-launcher", namespace, str({'conditions': None, 'load_balancer': {'ingress': None}})))
            except kubernetes.client.rest.ApiException as e:
                print("Exception when calling CoreV1Api->delete_namespaced_service_account: %s\n" % e)

        import argparse
        _parser = argparse.ArgumentParser(prog='Clear MPI Job', description='')
        _parser.add_argument("--name", dest="name", type=str, required=True, default=argparse.SUPPRESS)
        _parser.add_argument("--namespace", dest="namespace", type=str, required=True, default=argparse.SUPPRESS)
        _parser.add_argument("--num-worker", dest="num_worker", type=str, required=True, default=argparse.SUPPRESS)
        _parser.add_argument("--version", dest="version", type=str, required=False, default=argparse.SUPPRESS)
        _parsed_args = vars(_parser.parse_args())

        _outputs = Clear_MPI_Job(**_parsed_args)
      image: python:3.7
    inputs:
      parameters:
      - {name: name}
      - {name: namespace}
      - {name: num_worker}
    metadata:
      labels:
        pipelines.kubeflow.org/kfp_sdk_version: 1.8.22
        pipelines.kubeflow.org/pipeline-sdk-type: kfp
        pipelines.kubeflow.org/enable_caching: "true"
      annotations: {pipelines.kubeflow.org/component_spec: '{"implementation": {"container":
          {"args": ["--name", {"inputValue": "name"}, "--namespace", {"inputValue":
          "namespace"}, "--num-worker", {"inputValue": "num_worker"}, {"if": {"cond":
          {"isPresent": "version"}, "then": ["--version", {"inputValue": "version"}]}}],
          "command": ["sh", "-c", "(PIP_DISABLE_PIP_VERSION_CHECK=1 python3 -m pip
          install --quiet --no-warn-script-location ''kubernetes'' || PIP_DISABLE_PIP_VERSION_CHECK=1
          python3 -m pip install --quiet --no-warn-script-location ''kubernetes''
          --user) && \"$0\" \"$@\"", "sh", "-ec", "program_path=$(mktemp)\nprintf
          \"%s\" \"$0\" > \"$program_path\"\npython3 -u \"$program_path\" \"$@\"\n",
          "def Clear_MPI_Job(name, namespace, num_worker, version=\"v1\"):\n    import
          kubernetes\n    kubernetes.config.load_incluster_config()\n    api_instance_custom
          = kubernetes.client.CustomObjectsApi()\n    api_instance_core = kubernetes.client.CoreV1Api()\n    group
          = \"kubeflow.org\"\n    plural = \"mpijobs\"\n    try:\n        api_response
          = api_instance_custom.delete_namespaced_custom_object(\n            name=name,\n            namespace=namespace,\n            group=group,\n            version=version,\n            plural=plural,\n            body=kubernetes.client.models.V1DeleteOptions(\n                propagation_policy=''Foreground'',\n                grace_period_seconds=15\n            )\n        )\n        print(\"MPI-Job
          %s/%s deleted. Status=''%s''\" % (name, namespace, str(api_response.get(\"status\",
          None))))\n    except kubernetes.client.rest.ApiException as e:\n        print(\"Exception
          when calling CustomObjectsApi->delete_namespaced_custom_object: %s\\n\"
          % e)\n\n    try:\n        api_response = api_instance_core.delete_namespaced_service(name=f\"{name}-launcher\",
          namespace=namespace, body={\"propagationPolicy\": \"Foreground\"})\n        print(\"Service
          %s/%s deleted. Status=''%s''\" % (f\"{name}-launcher\", namespace, str(api_response.status)))\n        for
          index in range(int(num_worker)):\n            api_response = api_instance_core.delete_namespaced_service(name=f\"{name}-worker-{index}\",
          namespace=namespace, body={\"propagationPolicy\": \"Foreground\"})\n            print(\"Service
          %s/%s deleted. Status=''%s''\" % (f\"{name}-worker-{index}\", namespace,
          str(api_response.status)))\n    except kubernetes.client.rest.ApiException
          as e:\n        print(\"Exception when calling CoreV1Api->delete_namespaced_service:
          %s\\n\" % e)\n\n    try:\n        api_response = api_instance_core.delete_namespaced_service_account(name=f\"{name}-launcher\",
          namespace=namespace, body={\"propagationPolicy\": \"Foreground\"})\n        print(\"ServiceAccount
          %s/%s deleted. Status=''%s''\" % (f\"{name}-launcher\", namespace, str({''conditions'':
          None, ''load_balancer'': {''ingress'': None}})))\n    except kubernetes.client.rest.ApiException
          as e:\n        print(\"Exception when calling CoreV1Api->delete_namespaced_service_account:
          %s\\n\" % e)\n\nimport argparse\n_parser = argparse.ArgumentParser(prog=''Clear
          MPI Job'', description='''')\n_parser.add_argument(\"--name\", dest=\"name\",
          type=str, required=True, default=argparse.SUPPRESS)\n_parser.add_argument(\"--namespace\",
          dest=\"namespace\", type=str, required=True, default=argparse.SUPPRESS)\n_parser.add_argument(\"--num-worker\",
          dest=\"num_worker\", type=str, required=True, default=argparse.SUPPRESS)\n_parser.add_argument(\"--version\",
          dest=\"version\", type=str, required=False, default=argparse.SUPPRESS)\n_parsed_args
          = vars(_parser.parse_args())\n\n_outputs = Clear_MPI_Job(**_parsed_args)\n"],
          "image": "python:3.7"}}, "inputs": [{"name": "name"}, {"name": "namespace"},
          {"name": "num_worker"}, {"default": "v1", "name": "version", "optional":
          true}], "name": "Clear MPI Job"}', pipelines.kubeflow.org/component_ref: '{}',
        pipelines.kubeflow.org/arguments.parameters: '{"name": "{{inputs.parameters.name}}",
          "namespace": "{{inputs.parameters.namespace}}", "num_worker": "{{inputs.parameters.num_worker}}",
          "version": "v1"}'}
  - name: exit-handler-1
    inputs:
      parameters:
      - {name: command}
      - {name: cpu_per_worker}
      - {name: gpu_per_worker}
      - {name: image}
      - {name: memory_per_worker}
      - {name: name}
      - {name: namespace}
      - {name: num_worker}
    dag:
      tasks:
      - name: mpi-job-launcher
        template: mpi-job-launcher
        arguments:
          parameters:
          - {name: command, value: '{{inputs.parameters.command}}'}
          - {name: cpu_per_worker, value: '{{inputs.parameters.cpu_per_worker}}'}
          - {name: gpu_per_worker, value: '{{inputs.parameters.gpu_per_worker}}'}
          - {name: image, value: '{{inputs.parameters.image}}'}
          - {name: memory_per_worker, value: '{{inputs.parameters.memory_per_worker}}'}
          - {name: name, value: '{{inputs.parameters.name}}'}
          - {name: namespace, value: '{{inputs.parameters.namespace}}'}
          - {name: num_worker, value: '{{inputs.parameters.num_worker}}'}
  - name: launch-kubeflow-mpi-job
    inputs:
      parameters:
      - {name: command}
      - {name: cpu_per_worker}
      - {name: gpu_per_worker}
      - {name: image}
      - {name: memory_per_worker}
      - {name: name}
      - {name: namespace}
      - {name: num_worker}
    dag:
      tasks:
      - name: exit-handler-1
        template: exit-handler-1
        arguments:
          parameters:
          - {name: command, value: '{{inputs.parameters.command}}'}
          - {name: cpu_per_worker, value: '{{inputs.parameters.cpu_per_worker}}'}
          - {name: gpu_per_worker, value: '{{inputs.parameters.gpu_per_worker}}'}
          - {name: image, value: '{{inputs.parameters.image}}'}
          - {name: memory_per_worker, value: '{{inputs.parameters.memory_per_worker}}'}
          - {name: name, value: '{{inputs.parameters.name}}'}
          - {name: namespace, value: '{{inputs.parameters.namespace}}'}
          - {name: num_worker, value: '{{inputs.parameters.num_worker}}'}
  - name: mpi-job-launcher
    container:
      args: [--name, '{{inputs.parameters.name}}', --namespace, '{{inputs.parameters.namespace}}',
        --version, v1, --launcherSpec, '{               "replicas": 1,               "restartPolicy":
          "Never",               "template": {                 "metadata": {                   "annotations":
          {                     "sidecar.istio.io/inject": "false"                   },                   "labels":
          {                     "app": "yunikorn",                     "scheduling.x-k8s.io/pod-group":
          {{inputs.parameters.name}}                   }                 },                 "spec":
          {                   "containers": [                     {                       "name":
          "deepspeed",                       "image": "{{inputs.parameters.image}}",                       "command":
          ["/bin/bash", "-c", "{{inputs.parameters.command}}"],                       "resources":
          {                         "limits": {                           "cpu": {{inputs.parameters.cpu_per_worker}},                           "memory":
          {{inputs.parameters.memory_per_worker}}Gi,                           "nvidia.com/gpu":
          {{inputs.parameters.gpu_per_worker}}                         }                       },                       "volumeMounts":
          [                         {                             "name": "dshm",                             "mountPath":
          "/dev/shm"                         }                       ]                     }                   ],                   "volumes":
          [                     {                       "name": "dshm",                       "emptyDir":
          {                         "medium": "Memory"                       }                     }                   ],                   "schedulerName":
          "scheduler-plugins-scheduler"                 }               }             }',
        --workerSpec, '{               "replicas": {{inputs.parameters.num_worker}},               "restartPolicy":
          "Never",               "template": {                 "metadata": {                   "annotations":
          {                     "sidecar.istio.io/inject": "false"                   },                   "labels":
          {                     "app": "yunikorn",                     "scheduling.x-k8s.io/pod-group":
          {{inputs.parameters.name}}                   }                 },                 "spec":
          {                   "containers": [                     {                       "name":
          "deepspeed",                       "image": "{{inputs.parameters.image}}",                       "command":
          ["/bin/bash", "-c", "sleep 864000"],                       "resources":
          {                         "limits": {                           "cpu": {{inputs.parameters.cpu_per_worker}},                           "memory":
          {{inputs.parameters.memory_per_worker}}Gi,                           "nvidia.com/gpu":
          {{inputs.parameters.gpu_per_worker}}                         }                       },                       "volumeMounts":
          [                         {                             "name": "dshm",                             "mountPath":
          "/dev/shm"                         }                       ]                     }                   ],                   "volumes":
          [                     {                       "name": "dshm",                       "emptyDir":
          {                         "medium": "Memory"                       }                     }                   ],                   "schedulerName":
          "scheduler-plugins-scheduler"                 }               }             }',
        --scheduleTimeoutSeconds, '1440', --schedulingPolicy, '{}', --cleanPodPolicy,
        Running]
      command: [python, /ml/launch_mpi_job.py]
      image: yhjh5302/kubeflow-mpi-job-launcher:v1
    inputs:
      parameters:
      - {name: command}
      - {name: cpu_per_worker}
      - {name: gpu_per_worker}
      - {name: image}
      - {name: memory_per_worker}
      - {name: name}
      - {name: namespace}
      - {name: num_worker}
      artifacts:
      - name: delete_after_done
        path: /tmp/inputs/delete_after_done/data
        raw:
          data: "True"
      - name: job_timeout_minutes
        path: /tmp/inputs/job_timeout_minutes/data
        raw: {data: '1440'}
    metadata:
      labels:
        pipelines.kubeflow.org/kfp_sdk_version: 1.8.22
        pipelines.kubeflow.org/pipeline-sdk-type: kfp
        pipelines.kubeflow.org/enable_caching: "true"
      annotations: {pipelines.kubeflow.org/component_spec: '{"description": "Kubeflow
          MPIJob launcher", "implementation": {"container": {"args": ["--name", {"inputValue":
          "name"}, "--namespace", {"inputValue": "namespace"}, "--version", {"inputValue":
          "version"}, "--launcherSpec", {"inputValue": "launcher_spec"}, "--workerSpec",
          {"inputValue": "worker_spec"}, "--scheduleTimeoutSeconds", {"inputValue":
          "schedule_timeout_seconds"}, "--schedulingPolicy", {"inputValue": "scheduling_policy"},
          "--cleanPodPolicy", {"inputValue": "clean_pod_policy"}, {"if": {"cond":
          {"isPresent": "active_deadline_seconds"}, "then": ["--activeDeadlineSeconds",
          {"inputValue": "active_deadline_seconds"}]}}, {"if": {"cond": {"isPresent":
          "backoff_limit"}, "then": ["--backoffLimit", {"inputValue": "backoff_limit"}]}},
          {"if": {"cond": {"isPresent": "ttl_seconds_after_finished"}, "then": ["--ttlSecondsAfterFinished",
          {"inputValue": "ttl_seconds_after_finished"}]}}], "command": ["python",
          "/ml/launch_mpi_job.py"], "image": "yhjh5302/kubeflow-mpi-job-launcher:v1"}},
          "inputs": [{"description": "MPIJob name.", "name": "name", "type": "String"},
          {"default": "kubeflow", "description": "MPIJob namespace (likely your current
          namespace).", "name": "namespace", "type": "String"}, {"default": "v1",
          "description": "MPIJob version.", "name": "version", "type": "String"},
          {"default": "{}", "description": "MPIJob Launcher replicaSpecs.", "name":
          "launcher_spec", "type": "JsonObject"}, {"default": "{}", "description":
          "MPIJob Worker replicaSpecs.", "name": "worker_spec", "type": "JsonObject"},
          {"default": 1440, "description": "Time in seconds to wait for the job to
          schedule.", "name": "schedule_timeout_seconds", "type": "Integer"}, {"default":
          "{}", "description": "MPIJob supports the gang-scheduling.", "name": "scheduling_policy",
          "type": "JsonObject"}, {"default": 1440, "description": "Time in minutes
          to wait for the job to complete.", "name": "job_timeout_minutes", "type":
          "Integer"}, {"default": "True", "description": "Whether to delete the job
          after it is finished.", "name": "delete_after_done", "type": "Boolean"},
          {"default": "Running", "description": "Defines the policy for cleaning up
          pods after the MPIJob completes.", "name": "clean_pod_policy", "type": "String"},
          {"description": "Specifies the duration (in seconds) since startTime during
          which the job can remain active before it is terminated. Must be a positive
          integer. This setting applies only to pods where restartPolicy is OnFailure
          or Always.", "name": "active_deadline_seconds", "optional": true, "type":
          "Integer"}, {"description": "Number of retries before marking this job as
          failed.", "name": "backoff_limit", "optional": true, "type": "Integer"},
          {"description": "Defines the TTL for cleaning up finished MPIJobs.", "name":
          "ttl_seconds_after_finished", "optional": true, "type": "Integer"}], "name":
          "MPI-Job Launcher"}', pipelines.kubeflow.org/component_ref: '{"digest":
          "3a6fc91a4fe1dfa94bf57452a021802979231337cffbb4e04d19394bfecb4c50", "url":
          "./mpi_job_component.yaml"}', pipelines.kubeflow.org/arguments.parameters: '{"clean_pod_policy":
          "Running", "launcher_spec": "{               \"replicas\": 1,               \"restartPolicy\":
          \"Never\",               \"template\": {                 \"metadata\": {                   \"annotations\":
          {                     \"sidecar.istio.io/inject\": \"false\"                   },                   \"labels\":
          {                     \"app\": \"yunikorn\",                     \"scheduling.x-k8s.io/pod-group\":
          {{inputs.parameters.name}}                   }                 },                 \"spec\":
          {                   \"containers\": [                     {                       \"name\":
          \"deepspeed\",                       \"image\": \"{{inputs.parameters.image}}\",                       \"command\":
          [\"/bin/bash\", \"-c\", \"{{inputs.parameters.command}}\"],                       \"resources\":
          {                         \"limits\": {                           \"cpu\":
          {{inputs.parameters.cpu_per_worker}},                           \"memory\":
          {{inputs.parameters.memory_per_worker}}Gi,                           \"nvidia.com/gpu\":
          {{inputs.parameters.gpu_per_worker}}                         }                       },                       \"volumeMounts\":
          [                         {                             \"name\": \"dshm\",                             \"mountPath\":
          \"/dev/shm\"                         }                       ]                     }                   ],                   \"volumes\":
          [                     {                       \"name\": \"dshm\",                       \"emptyDir\":
          {                         \"medium\": \"Memory\"                       }                     }                   ],                   \"schedulerName\":
          \"scheduler-plugins-scheduler\"                 }               }             }",
          "name": "{{inputs.parameters.name}}", "namespace": "{{inputs.parameters.namespace}}",
          "schedule_timeout_seconds": "1440", "scheduling_policy": "{}", "version":
          "v1", "worker_spec": "{               \"replicas\": {{inputs.parameters.num_worker}},               \"restartPolicy\":
          \"Never\",               \"template\": {                 \"metadata\": {                   \"annotations\":
          {                     \"sidecar.istio.io/inject\": \"false\"                   },                   \"labels\":
          {                     \"app\": \"yunikorn\",                     \"scheduling.x-k8s.io/pod-group\":
          {{inputs.parameters.name}}                   }                 },                 \"spec\":
          {                   \"containers\": [                     {                       \"name\":
          \"deepspeed\",                       \"image\": \"{{inputs.parameters.image}}\",                       \"command\":
          [\"/bin/bash\", \"-c\", \"sleep 864000\"],                       \"resources\":
          {                         \"limits\": {                           \"cpu\":
          {{inputs.parameters.cpu_per_worker}},                           \"memory\":
          {{inputs.parameters.memory_per_worker}}Gi,                           \"nvidia.com/gpu\":
          {{inputs.parameters.gpu_per_worker}}                         }                       },                       \"volumeMounts\":
          [                         {                             \"name\": \"dshm\",                             \"mountPath\":
          \"/dev/shm\"                         }                       ]                     }                   ],                   \"volumes\":
          [                     {                       \"name\": \"dshm\",                       \"emptyDir\":
          {                         \"medium\": \"Memory\"                       }                     }                   ],                   \"schedulerName\":
          \"scheduler-plugins-scheduler\"                 }               }             }"}'}
  arguments:
    parameters:
    - {name: name, value: ''}
    - {name: namespace, value: ''}
    - {name: image, value: ''}
    - {name: command, value: ''}
    - {name: num_worker, value: '3'}
    - {name: cpu_per_worker, value: '16'}
    - {name: memory_per_worker, value: '32'}
    - {name: gpu_per_worker, value: '1'}
  serviceAccountName: pipeline-runner
  onExit: clear-mpi-job
